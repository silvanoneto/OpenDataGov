# ===== OpenDataGov - Small Profile =====
# Resources: 16 vCPU, 64GB RAM
# Target: Small teams, <1TB/day

# ─── Global Settings ─────────────────────────────────────
global:
  profile: small
  domain: opendatagov.local
  storageClass: standard

# ─── Infrastructure ────────────────────────────────────
postgresql:
  enabled: true
  auth:
    username: odg
    password: secure_password_change_me
    database: odg
  primary:
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi
    persistence:
      enabled: true
      size: 50Gi

redis:
  enabled: true
  auth:
    enabled: true
    password: redis_password_change_me
  master:
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: "1"
        memory: 1Gi
    persistence:
      enabled: true
      size: 10Gi

minio:
  enabled: true
  auth:
    rootUser: admin
    rootPassword: secure_minio_password_change_me
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: "1"
      memory: 2Gi
  persistence:
    enabled: true
    size: 100Gi

kafka:
  enabled: true
  broker:
    replicaCount: 1
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi
    persistence:
      size: 50Gi
  # Security configuration (ADR-073)
  auth:
    enabled: true
    clientProtocol: sasl_ssl  # SASL + TLS
    interBrokerProtocol: sasl_ssl
    sasl:
      mechanism: SCRAM-SHA-512
      jaas:
        clientUsers:
          - odg-producer
          - odg-consumer
          - odg-admin
        clientPasswords:
          - producer-password-change-me
          - consumer-password-change-me
          - admin-password-change-me
        interBrokerUser: admin
        interBrokerPassword: broker-password-change-me
  tls:
    enabled: true
    autoGenerated: true  # Auto-generate self-signed certs
    type: jks
  # Audit log retention (Phase 5)
  logRetentionBytes: 1073741824  # 1GB per partition
  logRetentionHours: 8760  # 1 year
  numPartitions: 10
  replicationFactor: 1

# ─── Layer 5: Analytics & Query ─────────────────────────
trino:
  enabled: true
  server:
    coordinator:
      resources:
        requests:
          cpu: "1"
          memory: 2Gi
        limits:
          cpu: "2"
          memory: 4Gi
    worker:
      replicas: 1
      resources:
        requests:
          cpu: "1"
          memory: 2Gi
        limits:
          cpu: "2"
          memory: 4Gi

airflow:
  enabled: true
  postgresql:
    enabled: true
  redis:
    enabled: true
  webserver:
    replicas: 1
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: "1"
        memory: 2Gi
  scheduler:
    replicas: 1
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: "1"
        memory: 2Gi
  workers:
    replicas: 1
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi

superset:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi

timescaledb:
  enabled: true
  image:
    repository: timescale/timescaledb
    tag: 2.18.0-pg17
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: "1"
      memory: 2Gi
  persistence:
    enabled: true
    size: 50Gi

# ─── AI Components (Disabled in small) ──────────────────
qdrant:
  enabled: false

kubeflow:
  enabled: false

# ─── Spark Cluster ──────────────────────────────────────
spark:
  enabled: true
  master:
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: "1"
        memory: 2Gi
  worker:
    replicaCount: 2
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 2Gi
    env:
      SPARK_WORKER_MEMORY: "2G"
      SPARK_WORKER_CORES: "2"

# ─── Data Catalog ───────────────────────────────────────
datahub:
  enabled: true
  gms:
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi
  frontend:
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: "1"
        memory: 2Gi

# ─── Observability ──────────────────────────────────────
grafana:
  enabled: true
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

loki:
  enabled: true
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: "1"
      memory: 2Gi

tempo:
  enabled: true
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi

# ─── Auth & Security ────────────────────────────────────
keycloak:
  enabled: true
  auth:
    adminUser: admin
    adminPassword: changeme_keycloak_admin
  postgresql:
    enabled: false  # Use shared PostgreSQL
  externalDatabase:
    host: "{{ .Release.Name }}-postgresql"
    port: 5432
    user: odg
    database: odg
    password: secure_password_change_me
  service:
    type: ClusterIP
    ports:
      http: 8080
  replicaCount: 1
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 1Gi
  persistence:
    enabled: true
    size: 2Gi

opa:
  enabled: true
  replicas: 1
  admissionControllerKind: ""
  mgmt:
    enabled: true
  authz:
    enabled: false
  bootstrapPolicies:
    configMapName: "{{ .Release.Name }}-opa-policies"
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  persistence:
    enabled: true
    size: 1Gi

vault:
  enabled: true
  server:
    ha:
      enabled: true
      replicas: 3
      raft:
        enabled: true
        setNodeId: true
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: "1"
        memory: 2Gi
    dataStorage:
      enabled: true
      size: 10Gi
    auditStorage:
      enabled: true
      size: 5Gi

istio:
  enabled: true
  profile: minimal
  pilot:
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        cpu: "1"
        memory: 2Gi

networkPolicies:
  enabled: true
  enforceMode: true  # Strict enforcement for production

# ─── Custom Services ────────────────────────────────────
governance-engine:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5

lakehouse-agent:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi

data-expert:
  enabled: false  # No GPU in small

quality-gate:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi

gateway:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: "1"
      memory: 2Gi

# ─── Ingress ────────────────────────────────────────────
ingress:
  enabled: false

# ─── Service Monitor ────────────────────────────────────
serviceMonitor:
  enabled: true

certManager:
  enabled: true
  installCRDs: true
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 250m
      memory: 256Mi

podSecurity:
  enabled: true
  enforce: restricted  # Strict for production
