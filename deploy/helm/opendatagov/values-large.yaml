# ===== OpenDataGov - Large Profile =====
# Resources: 256+ vCPU, 1TB+ RAM, 2+ GPUs
# Target: Large-scale, >10TB/day, Multi-AZ, HA

# ─── Global Settings ─────────────────────────────────────
global:
  profile: large
  domain: opendatagov.example.com
  storageClass: gp3
  highAvailability: true
  multiAZ: true
  gpu:
    enabled: true
    count: 2

# ─── Infrastructure (HA Mode) ───────────────────────────
postgresql:
  enabled: true
  architecture: replication
  auth:
    username: odg
    password: production_password_use_vault
    database: odg
  primary:
    resources:
      requests:
        cpu: "4"
        memory: 16Gi
      limits:
        cpu: "8"
        memory: 32Gi
    persistence:
      enabled: true
      size: 500Gi
  readReplicas:
    replicaCount: 2
    resources:
      requests:
        cpu: "4"
        memory: 16Gi
      limits:
        cpu: "8"
        memory: 32Gi

redis:
  enabled: true
  architecture: replication
  auth:
    enabled: true
    password: production_redis_password_use_vault
  master:
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi
    persistence:
      enabled: true
      size: 50Gi
  replica:
    replicaCount: 2
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi

minio:
  enabled: true
  mode: distributed
  statefulset:
    replicaCount: 4
  auth:
    rootUser: admin
    rootPassword: production_minio_password_use_vault
  resources:
    requests:
      cpu: "2"
      memory: 8Gi
    limits:
      cpu: "4"
      memory: 16Gi
  persistence:
    enabled: true
    size: 1Ti

kafka:
  enabled: true
  broker:
    replicaCount: 5
    resources:
      requests:
        cpu: "4"
        memory: 8Gi
      limits:
        cpu: "8"
        memory: 16Gi
    persistence:
      size: 500Gi
  numPartitions: 20
  replicationFactor: 3
  # Security configuration (ADR-073)
  auth:
    enabled: true
    clientProtocol: sasl_ssl
    interBrokerProtocol: sasl_ssl
    sasl:
      mechanism: SCRAM-SHA-512
      jaas:
        clientUsers:
          - odg-producer
          - odg-consumer
          - odg-admin
        clientPasswords:
          - producer-password-change-me
          - consumer-password-change-me
          - admin-password-change-me
        interBrokerUser: admin
        interBrokerPassword: broker-password-change-me
  tls:
    enabled: true
    autoGenerated: true
    type: jks
  logRetentionBytes: 5368709120  # 5GB per partition
  logRetentionHours: 8760  # 1 year

kafka-connect:
  enabled: true
  replicaCount: 3  # HA for large profile
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      cpu: "4"
      memory: 8Gi
  kafka:
    bootstrapServers: kafka:9092
    groupId: kafka-connect-cluster
    configStorageTopic: connect-configs
    offsetStorageTopic: connect-offsets
    statusStorageTopic: connect-status
    replicationFactor: 3
  connectors:
    postgresql:
      enabled: true
    timescaledb:
      enabled: true
  errorHandling:
    tolerance: none
    logEnable: true
    logIncludeMessages: true

# ─── Layer 5: Analytics & Query (Maximum Scale) ─────────
trino:
  enabled: true
  server:
    coordinator:
      replicas: 1
      resources:
        requests:
          cpu: "8"
          memory: 32Gi
        limits:
          cpu: "16"
          memory: 64Gi
    worker:
      replicas: 5
      resources:
        requests:
          cpu: "8"
          memory: 32Gi
        limits:
          cpu: "16"
          memory: 64Gi

airflow:
  enabled: true
  postgresql:
    enabled: true
  redis:
    enabled: true
  webserver:
    replicas: 2
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi
  scheduler:
    replicas: 2  # HA mode
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi
  workers:
    replicas: 5
    resources:
      requests:
        cpu: "4"
        memory: 8Gi
      limits:
        cpu: "8"
        memory: 16Gi

superset:
  enabled: true
  replicaCount: 5
  resources:
    requests:
      cpu: "4"
      memory: 16Gi
    limits:
      cpu: "8"
      memory: 32Gi

timescaledb:
  enabled: true
  image:
    repository: timescale/timescaledb
    tag: 2.18.0-pg17
  replicaCount: 3  # HA replicas
  resources:
    requests:
      cpu: "4"
      memory: 16Gi
    limits:
      cpu: "8"
      memory: 32Gi
  persistence:
    enabled: true
    size: 1Ti

# ─── AI & ML Components (Clustered) ─────────────────────
qdrant:
  enabled: true
  replicaCount: 3  # Cluster mode
  resources:
    requests:
      cpu: "4"
      memory: 16Gi
    limits:
      cpu: "8"
      memory: 32Gi
  persistence:
    size: 500Gi

kubeflow:
  enabled: true
  apiServer:
    replicas: 3
    resources:
      requests:
        cpu: "2"
        memory: 8Gi
      limits:
        cpu: "4"
        memory: 16Gi

# ─── MLOps Stack (HA Configuration) ─────────────────────
mlflow:
  enabled: true
  replicaCount: 3
  resources:
    requests:
      cpu: "4"
      memory: 8Gi
    limits:
      cpu: "8"
      memory: 16Gi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
  backend:
    postgresql:
      enabled: true
      host: ""  # Auto-configured to shared PostgreSQL
      database: mlflow
    artifactStore:
      type: s3
      s3:
        endpointUrl: ""  # Auto-configured to MinIO (distributed mode)
        bucket: mlflow-artifacts
  governance:
    enabled: true
    governanceEngineUrl: "http://governance-engine:8000"
    promotionRequiresApproval: true
    raci:
      responsible: "data_scientist"
      accountable: "data_architect"
      consulted: "data_owner"
      informed: "data_steward"
  ha:
    enabled: true
    readReplicas: 2
  monitoring:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
  vault:
    enabled: true  # Use Vault for secrets management
    role: mlflow
    secretPath: secret/data/mlflow
  postgresql:
    enabled: false  # Use shared HA PostgreSQL instance

# ─── Spark Cluster (Large Scale) ────────────────────────
spark:
  enabled: true
  master:
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi
  worker:
    replicaCount: 5
    resources:
      requests:
        cpu: "8"
        memory: 32Gi
      limits:
        cpu: "16"
        memory: 32Gi
    env:
      SPARK_WORKER_MEMORY: "32G"
      SPARK_WORKER_CORES: "8"

# ─── Data Catalog ───────────────────────────────────────
datahub:
  enabled: true
  gms:
    replicas: 3
    resources:
      requests:
        cpu: "4"
        memory: 8Gi
      limits:
        cpu: "8"
        memory: 16Gi
  frontend:
    replicas: 2
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi

# ─── Observability (Production Grade) ──────────────────
grafana:
  enabled: true
  replicas: 2
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi

loki:
  enabled: true
  replicas: 3
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      cpu: "4"
      memory: 8Gi

tempo:
  enabled: true
  replicas: 3
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi

# ─── Auth & Security (HA) ───────────────────────────────
keycloak:
  enabled: true
  auth:
    adminUser: admin
    adminPassword: changeme_keycloak_admin
  postgresql:
    enabled: false
  externalDatabase:
    host: "{{ .Release.Name }}-postgresql"
    port: 5432
    user: odg
    database: odg
    password: secure_password_change_me
  service:
    type: ClusterIP
    ports:
      http: 8080
  replicaCount: 3
  resources:
    requests:
      cpu: "2"
      memory: 2Gi
    limits:
      cpu: "4"
      memory: 4Gi
  persistence:
    enabled: true
    size: 10Gi
  podDisruptionBudget:
    enabled: true
    minAvailable: 2

opa:
  enabled: true
  replicas: 3
  admissionControllerKind: ""
  mgmt:
    enabled: true
  authz:
    enabled: false
  bootstrapPolicies:
    configMapName: "{{ .Release.Name }}-opa-policies"
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi
  persistence:
    enabled: true
    size: 5Gi
  podDisruptionBudget:
    enabled: true
    minAvailable: 2

vault:
  enabled: true
  server:
    ha:
      enabled: true
      replicas: 5
      raft:
        enabled: true
        setNodeId: true
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi
    dataStorage:
      enabled: true
      size: 50Gi
    auditStorage:
      enabled: true
      size: 20Gi
  injector:
    enabled: true
    replicas: 2
    resources:
      requests:
        cpu: 500m
        memory: 512Mi
      limits:
        cpu: "1"
        memory: 1Gi

istio:
  enabled: true
  profile: production
  pilot:
    replicas: 3
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi

networkPolicies:
  enabled: true
  enforceMode: true
  zeroTrust: true

# ─── Custom Services (Maximum Scale + HA) ───────────────
governance-engine:
  enabled: true
  replicaCount: 5
  resources:
    requests:
      cpu: "8"
      memory: 32Gi
    limits:
      cpu: "16"
      memory: 64Gi
  autoscaling:
    enabled: true
    minReplicas: 5
    maxReplicas: 20
  podDisruptionBudget:
    enabled: true
    minAvailable: 3

lakehouse-agent:
  enabled: true
  replicaCount: 3
  resources:
    requests:
      cpu: "4"
      memory: 16Gi
    limits:
      cpu: "8"
      memory: 32Gi

data-expert:
  enabled: true
  replicaCount: 3
  resources:
    requests:
      cpu: "4"
      memory: 16Gi
    limits:
      cpu: "8"
      memory: 32Gi
  gpu:
    enabled: true
    count: 2
    type: nvidia.com/gpu

quality-gate:
  enabled: true
  replicaCount: 3
  resources:
    requests:
      cpu: "4"
      memory: 16Gi
    limits:
      cpu: "8"
      memory: 32Gi

gateway:
  enabled: true
  replicaCount: 3
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      cpu: "4"
      memory: 8Gi

finops-dashboard:
  enabled: true
  replicaCount: 3
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      cpu: "8"
      memory: 16Gi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
  database:
    url: "postgresql+asyncpg://odg:odg@postgres:5432/finops"
  aws:
    enabled: true
    region: "us-east-1"
  gcp:
    enabled: true
    projectId: "your-gcp-project"
  azure:
    enabled: true
    subscriptionId: "your-azure-subscription"
  costCollection:
    schedule: "0 */4 * * *"  # Every 4 hours (more frequent)
  budgetCheck:
    schedule: "0 * * * *"  # Every hour
  anomalyDetection:
    schedule: "0 1,13 * * *"  # Twice daily (1am, 1pm)
    lookbackDays: 90
    zscore_threshold: 3.0
  recommendations:
    schedule: "0 2 * * *"  # Daily at 2am
    cpu_threshold: 20.0
    memory_threshold: 30.0
    ri_utilization_threshold: 80.0

# ─── Ingress (Production) ───────────────────────────────
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
  tls:
    - secretName: opendatagov-tls
      hosts:
        - "*.opendatagov.example.com"

# ─── Service Monitor ────────────────────────────────────
serviceMonitor:
  enabled: true

# ─── ArgoCD (GitOps) ────────────────────────────────────
argocd:
  enabled: true

certManager:
  enabled: true
  installCRDs: true
  replicaCount: 3
  resources:
    requests:
      cpu: 500m
      memory: 512Mi
    limits:
      cpu: "1"
      memory: 1Gi
  webhook:
    replicaCount: 2
  cainjector:
    replicaCount: 2

podSecurity:
  enabled: true
  enforce: restricted  # Strict for production
