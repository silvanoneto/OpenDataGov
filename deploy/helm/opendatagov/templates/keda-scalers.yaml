{{- if .Values.keda.enabled }}
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ .Release.Name }}-governance-engine-scaler
  labels:
    app: governance-engine
    app.kubernetes.io/part-of: opendatagov
spec:
  scaleTargetRef:
    name: {{ .Release.Name }}-governance-engine
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  minReplicaCount: {{ .Values.keda.minReplicas }}
  maxReplicaCount: {{ .Values.keda.maxReplicas }}
  triggers:
    - type: nats-jetstream
      metadata:
        natsServerMonitoringEndpoint: "{{ .Release.Name }}-nats:8222"
        account: "$G"
        stream: governance
        consumer: governance-engine
        lagThreshold: "100"
    - type: cpu
      metricType: Utilization
      metadata:
        value: "70"
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ .Release.Name }}-lakehouse-agent-scaler
  labels:
    app: lakehouse-agent
    app.kubernetes.io/part-of: opendatagov
spec:
  scaleTargetRef:
    name: {{ .Release.Name }}-lakehouse-agent
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  minReplicaCount: {{ .Values.keda.minReplicas }}
  maxReplicaCount: {{ .Values.keda.maxReplicas }}
  triggers:
    - type: cpu
      metricType: Utilization
      metadata:
        value: "70"
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ .Release.Name }}-quality-gate-scaler
  labels:
    app: quality-gate
    app.kubernetes.io/part-of: opendatagov
spec:
  scaleTargetRef:
    name: {{ .Release.Name }}-quality-gate
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  minReplicaCount: {{ .Values.keda.minReplicas }}
  maxReplicaCount: {{ .Values.keda.maxReplicas }}
  triggers:
    - type: cpu
      metricType: Utilization
      metadata:
        value: "70"
{{- end }}
