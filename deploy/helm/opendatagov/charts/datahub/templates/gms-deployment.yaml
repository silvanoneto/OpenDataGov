{{- if .Values.gms.enabled }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "datahub.fullname" . }}-gms
  labels:
    {{- include "datahub.labels" . | nindent 4 }}
    app.kubernetes.io/component: gms
spec:
  {{- if not .Values.gms.autoscaling.enabled }}
  replicas: {{ .Values.gms.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "datahub.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: gms
  template:
    metadata:
      labels:
        {{- include "datahub.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: gms
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "{{ .Values.gms.service.port }}"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: {{ include "datahub.serviceAccountName" . }}
      securityContext:
        {{- toYaml .Values.podSecurityContext | nindent 8 }}
      initContainers:
      - name: wait-for-dependencies
        image: busybox:1.35
        command:
          - sh
          - -c
          - |
            echo "Waiting for PostgreSQL..."
            until nc -z {{ include "datahub.postgresql.host" . }} 5432; do
              echo "PostgreSQL not ready, waiting..."
              sleep 2
            done
            echo "Waiting for Elasticsearch..."
            until nc -z {{ include "datahub.elasticsearch.host" . }} 9200; do
              echo "Elasticsearch not ready, waiting..."
              sleep 2
            done
            echo "Waiting for Kafka..."
            until nc -z {{ .Release.Name }}-kafka 9092; do
              echo "Kafka not ready, waiting..."
              sleep 2
            done
            echo "All dependencies ready!"
      containers:
      - name: gms
        securityContext:
          {{- toYaml .Values.securityContext | nindent 10 }}
        image: "{{ .Values.global.imageRegistry }}/{{ .Values.gms.image.repository }}:{{ .Values.gms.image.tag }}"
        imagePullPolicy: {{ .Values.global.imagePullPolicy }}
        ports:
        - name: http
          containerPort: {{ .Values.gms.service.port }}
          protocol: TCP
        env:
        # PostgreSQL configuration
        - name: EBEAN_DATASOURCE_USERNAME
          value: {{ .Values.postgresql.auth.username }}
        - name: EBEAN_DATASOURCE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-postgresql
              key: password
        - name: EBEAN_DATASOURCE_HOST
          value: {{ include "datahub.postgresql.host" . }}:5432
        - name: EBEAN_DATASOURCE_URL
          value: "jdbc:postgresql://{{ include "datahub.postgresql.host" . }}:5432/{{ .Values.postgresql.auth.database }}"
        - name: EBEAN_DATASOURCE_DRIVER
          value: org.postgresql.Driver

        # Elasticsearch configuration
        - name: ELASTICSEARCH_HOST
          value: {{ include "datahub.elasticsearch.host" . }}
        - name: ELASTICSEARCH_PORT
          value: "9200"

        # Kafka configuration
        - name: KAFKA_BOOTSTRAP_SERVER
          value: {{ include "datahub.kafka.bootstrap" . }}
        - name: KAFKA_SCHEMAREGISTRY_URL
          value: http://{{ .Release.Name }}-kafka:8081

        # DataHub configuration
        {{- range .Values.gms.env }}
        - name: {{ .name }}
          value: {{ .value | quote }}
        {{- end }}

        livenessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5
        readinessProbe:
          httpGet:
            path: /health
            port: http
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
        resources:
          {{- toYaml .Values.gms.resources | nindent 10 }}
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      volumes:
      - name: tmp
        emptyDir: {}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
---
apiVersion: v1
kind: Service
metadata:
  name: {{ include "datahub.fullname" . }}-gms
  labels:
    {{- include "datahub.labels" . | nindent 4 }}
    app.kubernetes.io/component: gms
spec:
  type: {{ .Values.gms.service.type }}
  ports:
  - port: {{ .Values.gms.service.port }}
    targetPort: http
    protocol: TCP
    name: http
  selector:
    {{- include "datahub.selectorLabels" . | nindent 4 }}
    app.kubernetes.io/component: gms
{{- end }}
