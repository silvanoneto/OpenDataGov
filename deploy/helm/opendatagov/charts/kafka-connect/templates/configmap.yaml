apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "kafka-connect.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "kafka-connect.labels" . | nindent 4 }}
data:
  connect-distributed.properties: |
    # Kafka Connect configuration
    bootstrap.servers={{ .Values.kafka.bootstrapServers }}
    group.id={{ .Values.kafka.groupId }}

    # Connector configs
    config.storage.topic={{ .Values.kafka.configStorageTopic }}
    offset.storage.topic={{ .Values.kafka.offsetStorageTopic }}
    status.storage.topic={{ .Values.kafka.statusStorageTopic }}

    config.storage.replication.factor={{ .Values.kafka.replicationFactor }}
    offset.storage.replication.factor={{ .Values.kafka.replicationFactor }}
    status.storage.replication.factor={{ .Values.kafka.replicationFactor }}

    # REST API
    rest.port={{ .Values.service.port }}
    rest.advertised.host.name={{ include "kafka-connect.fullname" . }}

    # Converter configuration
    key.converter=org.apache.kafka.connect.json.JsonConverter
    value.converter=org.apache.kafka.connect.json.JsonConverter
    key.converter.schemas.enable=true
    value.converter.schemas.enable=true

    # Plugin path
    plugin.path=/usr/share/java,/usr/share/confluent-hub-components

    # Producer configs
    producer.compression.type=snappy
    producer.max.request.size=5242880

    # Consumer configs
    consumer.max.poll.records=500
    consumer.max.poll.interval.ms=300000

    # Task configs
    task.shutdown.graceful.timeout.ms=30000

    # Error handling
    errors.tolerance={{ .Values.errorHandling.tolerance }}
    errors.log.enable={{ .Values.errorHandling.logEnable }}
    errors.log.include.messages={{ .Values.errorHandling.logIncludeMessages }}

  log4j.properties: |
    log4j.rootLogger=INFO, stdout
    log4j.appender.stdout=org.apache.log4j.ConsoleAppender
    log4j.appender.stdout.layout=org.apache.log4j.PatternLayout
    log4j.appender.stdout.layout.ConversionPattern=[%d] %p %m (%c)%n

    # Debezium logging
    log4j.logger.io.debezium=INFO
    log4j.logger.io.debezium.connector.postgresql=DEBUG

    # Kafka Connect logging
    log4j.logger.org.apache.kafka.connect=INFO
    log4j.logger.org.reflections=ERROR
