{{- if .Values.controller.webhook.enabled }}
apiVersion: v1
kind: Service
metadata:
  name: {{ include "kserve.fullname" . }}-webhook-service
  labels:
    {{- include "kserve.labels" . | nindent 4 }}
    app.kubernetes.io/component: webhook
spec:
  ports:
  - port: 443
    targetPort: {{ .Values.controller.webhook.port }}
    protocol: TCP
    name: https
  selector:
    {{- include "kserve.selectorLabels" . | nindent 4 }}
    control-plane: kserve-controller-manager
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingWebhookConfiguration
metadata:
  name: {{ include "kserve.fullname" . }}-validating-webhook
  labels:
    {{- include "kserve.labels" . | nindent 4 }}
  annotations:
    cert-manager.io/inject-ca-from: {{ .Release.Namespace }}/{{ include "kserve.fullname" . }}-serving-cert
webhooks:
- name: inferenceservice.kserve.io
  admissionReviewVersions: ["v1", "v1beta1"]
  clientConfig:
    service:
      name: {{ include "kserve.fullname" . }}-webhook-service
      namespace: {{ .Release.Namespace }}
      path: /validate-serving-kserve-io-v1beta1-inferenceservice
  failurePolicy: Fail
  sideEffects: None
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["serving.kserve.io"]
    apiVersions: ["v1beta1"]
    resources: ["inferenceservices"]
  {{- if .Values.governanceWebhook.enabled }}
- name: governance.opendatagov.io
  admissionReviewVersions: ["v1"]
  clientConfig:
    url: {{ .Values.governanceWebhook.url | quote }}
  failurePolicy: {{ .Values.governanceWebhook.failurePolicy }}
  sideEffects: None
  timeoutSeconds: {{ .Values.governanceWebhook.timeoutSeconds }}
  rules:
  - operations: ["CREATE", "UPDATE"]
    apiGroups: ["serving.kserve.io"]
    apiVersions: ["v1beta1"]
    resources: ["inferenceservices"]
    scope: "Namespaced"
  namespaceSelector:
    matchExpressions:
    - key: opendatagov.io/governance
      operator: In
      values: ["enabled"]
  {{- end }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: {{ include "kserve.fullname" . }}-serving-cert
  labels:
    {{- include "kserve.labels" . | nindent 4 }}
spec:
  dnsNames:
  - {{ include "kserve.fullname" . }}-webhook-service.{{ .Release.Namespace }}.svc
  - {{ include "kserve.fullname" . }}-webhook-service.{{ .Release.Namespace }}.svc.cluster.local
  issuerRef:
    kind: Issuer
    name: {{ include "kserve.fullname" . }}-selfsigned-issuer
  secretName: kserve-webhook-server-cert
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  name: {{ include "kserve.fullname" . }}-selfsigned-issuer
  labels:
    {{- include "kserve.labels" . | nindent 4 }}
spec:
  selfSigned: {}
{{- end }}
