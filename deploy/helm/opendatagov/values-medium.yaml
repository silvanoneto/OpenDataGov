# ===== OpenDataGov - Medium Profile =====
# Resources: 64 vCPU, 256GB RAM, 1 GPU
# Target: Enterprise, 1-10TB/day, AI-enabled

# ─── Global Settings ─────────────────────────────────────
global:
  profile: medium
  domain: opendatagov.local
  storageClass: gp3  # AWS EBS gp3 or equivalent
  gpu:
    enabled: true
    count: 1

# ─── Infrastructure ────────────────────────────────────
postgresql:
  enabled: true
  auth:
    username: odg
    password: enterprise_password_change_me
    database: odg
  primary:
    resources:
      requests:
        cpu: "2"
        memory: 8Gi
      limits:
        cpu: "4"
        memory: 16Gi
    persistence:
      enabled: true
      size: 200Gi

redis:
  enabled: true
  auth:
    enabled: true
    password: enterprise_redis_password_change_me
  master:
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi
    persistence:
      enabled: true
      size: 20Gi

minio:
  enabled: true
  mode: distributed
  auth:
    rootUser: admin
    rootPassword: enterprise_minio_password_change_me
  resources:
    requests:
      cpu: "1"
      memory: 4Gi
    limits:
      cpu: "2"
      memory: 8Gi
  persistence:
    enabled: true
    size: 500Gi

kafka:
  enabled: true
  broker:
    replicaCount: 3
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi
    persistence:
      size: 100Gi
  numPartitions: 10
  # Security configuration (ADR-073)
  auth:
    enabled: true
    clientProtocol: sasl_ssl
    interBrokerProtocol: sasl_ssl
    sasl:
      mechanism: SCRAM-SHA-512
      jaas:
        clientUsers:
          - odg-producer
          - odg-consumer
          - odg-admin
        clientPasswords:
          - producer-password-change-me
          - consumer-password-change-me
          - admin-password-change-me
        interBrokerUser: admin
        interBrokerPassword: broker-password-change-me
  tls:
    enabled: true
    autoGenerated: true
    type: jks
  logRetentionBytes: 2147483648  # 2GB per partition
  logRetentionHours: 8760  # 1 year
  replicationFactor: 3  # HA with 3 brokers

kafka-connect:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi
  kafka:
    bootstrapServers: kafka:9092
    groupId: kafka-connect-cluster
    configStorageTopic: connect-configs
    offsetStorageTopic: connect-offsets
    statusStorageTopic: connect-status
    replicationFactor: 3
  connectors:
    postgresql:
      enabled: true
    timescaledb:
      enabled: true
  errorHandling:
    tolerance: none
    logEnable: true
    logIncludeMessages: true

# ─── Layer 5: Analytics & Query (Full Scale) ────────────
trino:
  enabled: true
  server:
    coordinator:
      resources:
        requests:
          cpu: "4"
          memory: 8Gi
        limits:
          cpu: "8"
          memory: 16Gi
    worker:
      replicas: 3
      resources:
        requests:
          cpu: "4"
          memory: 8Gi
        limits:
          cpu: "8"
          memory: 16Gi

airflow:
  enabled: true
  postgresql:
    enabled: true
  redis:
    enabled: true
  webserver:
    replicas: 1
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi
  scheduler:
    replicas: 1
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi
  workers:
    replicas: 3
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi

superset:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      cpu: "4"
      memory: 8Gi

timescaledb:
  enabled: true
  image:
    repository: timescale/timescaledb
    tag: 2.18.0-pg17
  replicaCount: 2
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      cpu: "4"
      memory: 8Gi
  persistence:
    enabled: true
    size: 200Gi

couchdb:
  enabled: true
  clusterSize: 3
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: "2"
      memory: 4Gi
  persistentVolume:
    enabled: true
    size: 20Gi

janusgraph:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi
  persistence:
    enabled: true
    size: 10Gi
  cassandra:
    enabled: true
    clusterSize: 3
    resources:
      requests:
        cpu: "1"
        memory: 4Gi
      limits:
        cpu: "2"
        memory: 8Gi
    persistence:
      enabled: true
      size: 50Gi

# ─── AI & ML Components (Enabled) ───────────────────────
qdrant:
  enabled: true
  replicaCount: 1
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      cpu: "4"
      memory: 8Gi
  persistence:
    size: 100Gi

kubeflow:
  enabled: true
  apiServer:
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi

# ─── MLOps Stack (Enabled) ──────────────────────────────
mlflow:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      cpu: "4"
      memory: 8Gi
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 75
  backend:
    postgresql:
      enabled: true
      host: ""  # Auto-configured to shared PostgreSQL
      database: mlflow
    artifactStore:
      type: s3
      s3:
        endpointUrl: ""  # Auto-configured to MinIO
        bucket: mlflow-artifacts
  governance:
    enabled: true  # Governance required for production promotions
    governanceEngineUrl: "http://governance-engine:8000"
    promotionRequiresApproval: true
    raci:
      responsible: "data_scientist"
      accountable: "data_architect"
      consulted: "data_owner"
      informed: "data_steward"
  monitoring:
    enabled: true
    serviceMonitor:
      enabled: true
      interval: 30s
  postgresql:
    enabled: false  # Use shared PostgreSQL instance

# ─── Spark Cluster ──────────────────────────────────────
spark:
  enabled: true
  master:
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi
  worker:
    replicaCount: 2
    resources:
      requests:
        cpu: "2"
        memory: 8Gi
      limits:
        cpu: "4"
        memory: 8Gi
    env:
      SPARK_WORKER_MEMORY: "8G"
      SPARK_WORKER_CORES: "4"

# ─── Data Catalog ───────────────────────────────────────
datahub:
  enabled: true
  gms:
    resources:
      requests:
        cpu: "2"
        memory: 4Gi
      limits:
        cpu: "4"
        memory: 8Gi
  frontend:
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi

# ─── Observability ──────────────────────────────────────
grafana:
  enabled: true
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: "1"
      memory: 2Gi

loki:
  enabled: true
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "2"
      memory: 4Gi

tempo:
  enabled: true
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: "1"
      memory: 2Gi

# ─── Auth & Security ────────────────────────────────────
keycloak:
  enabled: true
  auth:
    adminUser: admin
    adminPassword: changeme_keycloak_admin
  postgresql:
    enabled: false
  externalDatabase:
    host: "{{ .Release.Name }}-postgresql"
    port: 5432
    user: odg
    database: odg
    password: secure_password_change_me
  service:
    type: ClusterIP
    ports:
      http: 8080
  replicaCount: 2
  resources:
    requests:
      cpu: "1"
      memory: 1Gi
    limits:
      cpu: "2"
      memory: 2Gi
  persistence:
    enabled: true
    size: 5Gi

opa:
  enabled: true
  replicas: 2
  admissionControllerKind: ""
  mgmt:
    enabled: true
  authz:
    enabled: false
  bootstrapPolicies:
    configMapName: "{{ .Release.Name }}-opa-policies"
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: "1"
      memory: 2Gi
  persistence:
    enabled: true
    size: 2Gi

vault:
  enabled: true
  server:
    ha:
      enabled: true
      replicas: 3
      raft:
        enabled: true
        setNodeId: true
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi
    dataStorage:
      enabled: true
      size: 20Gi
    auditStorage:
      enabled: true
      size: 10Gi
  injector:
    enabled: true
    resources:
      requests:
        cpu: 250m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

istio:
  enabled: true
  profile: default
  pilot:
    replicas: 2
    resources:
      requests:
        cpu: "1"
        memory: 2Gi
      limits:
        cpu: "2"
        memory: 4Gi

networkPolicies:
  enabled: true
  enforceMode: true

# ─── Custom Services (Scaled) ───────────────────────────
governance-engine:
  enabled: true
  replicaCount: 3
  resources:
    requests:
      cpu: "4"
      memory: 8Gi
    limits:
      cpu: "8"
      memory: 16Gi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 10

lakehouse-agent:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      cpu: "4"
      memory: 8Gi

data-expert:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: "2"
      memory: 8Gi
    limits:
      cpu: "4"
      memory: 16Gi
  gpu:
    enabled: true
    count: 1
    type: nvidia.com/gpu

quality-gate:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: "2"
      memory: 4Gi
    limits:
      cpu: "4"
      memory: 8Gi

gateway:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: "1"
      memory: 1Gi
    limits:
      cpu: "2"
      memory: 2Gi

finops-dashboard:
  enabled: true
  replicaCount: 2
  resources:
    requests:
      cpu: "1"
      memory: 2Gi
    limits:
      cpu: "4"
      memory: 8Gi
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 5
    targetCPUUtilizationPercentage: 70
  database:
    url: "postgresql+asyncpg://odg:odg@postgres:5432/finops"
  aws:
    enabled: true
    region: "us-east-1"
  gcp:
    enabled: false
    projectId: "your-gcp-project"
  azure:
    enabled: false
  costCollection:
    schedule: "0 */6 * * *"  # Every 6 hours
  budgetCheck:
    schedule: "0 * * * *"  # Every hour
  anomalyDetection:
    schedule: "0 2 * * *"  # Daily at 2am
    lookbackDays: 90
    zscore_threshold: 3.0
  recommendations:
    schedule: "0 3 * * 0"  # Weekly on Sunday at 3am
    cpu_threshold: 20.0
    memory_threshold: 30.0
    ri_utilization_threshold: 80.0

# ─── Ingress ────────────────────────────────────────────
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
  tls:
    - secretName: opendatagov-tls
      hosts:
        - opendatagov.example.com

# ─── Service Monitor ────────────────────────────────────
serviceMonitor:
  enabled: true

certManager:
  enabled: true
  installCRDs: true
  replicaCount: 2
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

podSecurity:
  enabled: true
  enforce: restricted  # Strict for production
