name: CI Go

on:
  push:
    branches: [main]
    paths:
      - "services/gateway/**"
      - "libs/go/**"
  pull_request:
    branches: [main]
    paths:
      - "services/gateway/**"
      - "libs/go/**"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version-file: services/gateway/go.mod
      - name: golangci-lint
        uses: golangci/golangci-lint-action@1e7e51e771db61008b38414a730f564565cf7c20 # v9
        with:
          version: v2.8
          working-directory: services/gateway

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5
        with:
          go-version-file: services/gateway/go.mod
      - name: Run tests
        working-directory: services/gateway
        run: go test ./internal/... -v -race -coverprofile=coverage.out
      - name: Check coverage threshold
        working-directory: services/gateway
        run: |
          TOTAL=$(go tool cover -func=coverage.out | grep '^total:' | awk '{print $NF}' | tr -d '%')
          echo "Go coverage: ${TOTAL}% (threshold: 95%)"
          if awk "BEGIN{exit (${TOTAL} < 95) ? 0 : 1}"; then
            echo "FAIL: coverage ${TOTAL}% is below 95%"
            exit 1
          fi
      - name: Upload coverage
        uses: codecov/codecov-action@b9fd7d16f6d7d1b5d2bec1a2887e65ceed900238 # v4
        with:
          file: services/gateway/coverage.out
          flags: gateway

  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      - name: Build image
        run: docker build -t services/gateway:ci -f services/gateway/Dockerfile .
      - name: Trivy scan
        uses: aquasecurity/trivy-action@22438a435773de8c97dc0958cc0b823c45b064ac # master
        with:
          image-ref: "services/gateway:ci"
          severity: "CRITICAL,HIGH"
          exit-code: "1"
